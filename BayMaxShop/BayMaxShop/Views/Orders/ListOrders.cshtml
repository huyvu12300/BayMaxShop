@model IEnumerable<BayMaxShop.Models.EF.Order>
@{
    ViewBag.Title = "Index";
}
<link rel="stylesheet" type="text/css" href="~/Content/assets/styles/categories_styles.css">
<link rel="stylesheet" type="text/css" href="~/Content/assets/styles/categories_responsive.css">
<section class="content">
    <!-- Default box -->
    <div style="padding-top:180px" class="card">
        <div class="card-header">
            <h3 class="card-title" style="margin-left: 540px; font-size: 45px; margin-top: 60px;">Danh Sách Đơn Hàng Đã Đặt</h3>
        </div>
        @if (Model.Count() == 0)
        {
            <div class="card-header">
                <h3 class="card-title" style="margin-left: 660px; color: red; font-style: italic; margin-top: 70px; ">Bạn chưa có đơn hàng nào!</h3>
            </div>
        }
        else
        {
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Mã đơn hàng</th>
                            <th>Tên khách hàng</th>
                            <th>Phone</th>
                            <th>Tiền</th>
                            <th>Trạng thái</th>
                            <th>Ngày đặt</th>
                            <th width="350px"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            var i = 1;
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td>@i</td>
                                    <td>@item.Code</td>
                                    <td>@item.CustomerName</td>
                                    <td>@item.Phone</td>
                                    <td>@BayMaxShop.Common.Common.FormatNumber(item.TotalAmount, 0)</td>
                                    @*<td>@(item.TypePayment==1? "Chờ thanh toán": "Đã thanh toán")</td>*@
                                    @switch (item.TypePayment)
                                    {
                                        case 1:
                                            <td>Chờ Thanh Toán</td>
                                            break;
                                        case 2:
                                            <td>Đã Thanh Toán</td>
                                            break;
                                        case 3:
                                            <td>Hủy Đơn Hàng</td>
                                            break;
                                        default:
                                            break;
                                    }
                                    <td>@item.CreatedDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        @{
                                            TimeSpan time = DateTime.Now - item.CreatedDate;
                                            int countDate = time.Days;
                                            if (countDate <= 2 && item.TypePayment != 3)
                                            {
                                                <a href="/orders/view/@item.Id" class="btn btn-lg btn-info">Chi tiết</a>
                                                <a href="/orders/refund" class="btn btn-lg btn-warning">Trả hàng/Hoàn tiền</a>
                                                <a href="#" class="btn btn-lg btn-danger btnCapNhat" data-id="@item.Id" id="btnCapNhat">Hủy Đơn hàng</a>
                                            }
                                            if ((countDate <= 7 && countDate > 2) && item.TypePayment != 3)
                                            {
                                                <a href="/orders/view/@item.Id" class="btn btn-lg btn-info">Chi tiết</a>
                                                <a href="/orders/refund" class="btn btn-lg btn-warning">Trả hàng/Hoàn tiền</a>
                                            }
                                            if (countDate > 7 || item.TypePayment == 3)
                                            {
                                                <a href="/orders/view/@item.Id" class="btn btn-lg btn-info">Chi tiết</a>
                                            }
                                        }


                                    </td>
                                </tr>
                                i++;
                            }
                        }
                    </tbody>
                </table>
                <p style="color:gray;font-style:italic">Lưu ý: Bạn không thể hủy đơn quá 2 ngày và đổi trả hàng quá 7 ngày kể từ ngày đặt hàng!</p>
            </div>
        }
    </div>
</section>

<div class="modal fade" id="modal-default">
    <div class="modal-dialog">
        <div style="background-color: #F0B1DF; height: 280px; margin-top: 100px; " class="modal-content">
            <div class="modal-header">
                <h4 style="margin-left: 133px;" class="modal-title">Cập nhật trạng thái</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div style="width: 1500px;" class="modal-body">
                <input type="hidden" id="txtOrderId" value="0" />
                <div class="form-group">
                    <label style="margin-left: 180px; font-size: 20px;">Trạng thái</label>
                    <select style=" height: 40px; margin-left: 90px; margin-top: 20px; font-size: 15px; " class="form-control" id="ddTrangThai">
                        <option style="font-size: 13px;" value="3">
                            Huỷ đơn hàng
                        </option>
                    </select>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button style="width: 70px; height:40px; font-size: 15px;" type="button" class="btn btn-default" data-dismiss="modal">Đóng</button>
                <button style="background-color: #848FB3; width: 70px; height: 40px; margin-left: 350px; font-size: 15px; " type="button" class="btn btn-primary" id="btnLuu">Lưu</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
@section scripts{

    <script>
        $(document).ready(function () {
            $('body').on('click', '.btnCapNhat', function () {
                var id = $(this).data("id");
                $('#txtOrderId').val(id);
                $('#modal-default').modal('show');
            });

            $('body').on('click', '#btnLuu', function () {
                var id = $('#txtOrderId').val();
                var tt = $('#ddTrangThai').val();
                $.ajax({
                    url: '/orders/UpdateTT',
                    type: 'POST',
                    data: { id: id, trangthai: tt },
                    success: function (res) {
                        if (res.Success) {
                            location.reload();
                        }
                    }
                });
            });
        });
    </script>
}


